#!/usr/bin/env ruby

# frozen_string_literal: true

require 'open3'

class MigrationSchemaValidator
  FILENAME = 'db/structure.sql'

  MIGRATION_DIRS = %w[db/migrate db/post_migrate].freeze

  VERSION_DIGITS = 14

  def validate
    if committed_migrations.empty?
      puts "\e[32m No migrations found, skipping schema validation\e[0m"
      return
    end

    validate_schema_on_rollback!
    validate_schema_on_migrate!
  end

  private

  def validate_schema_on_rollback!
    committed_migrations.each do |filename|
      version = find_migration_version(filename)

      run("bin/rails db:migrate:down VERSION=#{version}")
    end

    git_command = "git diff #{merge_base} -- #{FILENAME}"
    base_message = "rollback of added migrations does not revert #{FILENAME} to previous state"

    validate_clean_output!(git_command, base_message)
  end

  def validate_schema_on_migrate!
    run('bin/rails db:migrate')

    git_command = "git diff -- #{FILENAME}"
    base_message = "the committed #{FILENAME} does not match the one generated by running added migrations"

    validate_clean_output!(git_command, base_message)
  end

  def committed_migrations
    @committed_migrations ||= begin
      git_command = "git diff --name-only --diff-filter=A #{merge_base} -- #{MIGRATION_DIRS.join(' ')}"

      run(git_command).split("\n")
    end
  end

  def merge_base
    @merge_base ||= run("git merge-base #{target_branch} #{source_ref}")
  end

  def target_branch
    ENV['CI_MERGE_REQUEST_TARGET_BRANCH_NAME'] || ENV['TARGET'] || 'master'
  end

  def source_ref
    ENV['CI_COMMIT_SHA'] || 'HEAD'
  end

  def find_migration_version(filename)
    version_start = filename =~ /\d{#{VERSION_DIGITS}}/

    die "#{filename} has an invalid migration version" if version_start.nil?

    filename.slice(version_start, VERSION_DIGITS)
  end

  def validate_clean_output!(command, base_message)
    command_output = run(command)

    return if command_output.empty?

    die "#{base_message}:\n#{command_output}"
  end

  def die(message, error_code: 1)
    puts "\e[31mError: #{message}\e[0m"
    exit error_code
  end

  def run(cmd)
    puts "\e[32m$ #{cmd}\e[37m"
    stdout_str, stderr_str, status = Open3.capture3(cmd)
    puts "#{stdout_str}#{stderr_str}\e[0m"

    die "command failed: #{stderr_str}" unless status.success?

    stdout_str.chomp
  end
end

MigrationSchemaValidator.new.validate
